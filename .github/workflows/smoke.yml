name: Smoke

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  jellyfin-smoke:
    name: Jellyfin Runtime Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Build plugin release
        run: dotnet build src/Jellyfin.Plugin.Shirarium/Jellyfin.Plugin.Shirarium.csproj -c Release

      - name: Prepare plugin mount
        run: |
          mkdir -p artifacts/plugin
          cp src/Jellyfin.Plugin.Shirarium/bin/Release/net9.0/Jellyfin.Plugin.Shirarium.dll artifacts/plugin/
          cp src/Jellyfin.Plugin.Shirarium/bin/Release/net9.0/Jellyfin.Plugin.Shirarium.pdb artifacts/plugin/
          cp src/Jellyfin.Plugin.Shirarium/bin/Release/net9.0/Jellyfin.Plugin.Shirarium.xml artifacts/plugin/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Jellyfin smoke flow
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p data/media
          mkdir -p data/jellyfin/config
          mkdir -p data/jellyfin/cache

                    export MEDIA_PATH="${GITHUB_WORKSPACE}/data/media"
                    export JELLYFIN_PORT=8097
                    export JELLYFIN_BASE_URL="http://localhost:${JELLYFIN_PORT}"
          
                    mkdir -p "${MEDIA_PATH}"
                    
                    cleanup() {
                      docker logs shirarium-jellyfin-dev || true
                      docker compose down -v || true
                    }
                    trap cleanup EXIT
          
                              docker compose up -d jellyfin-dev
                    
                              # Generate the dataset since it's untracked in git
                              python3 scripts/harvest_synthetic_dataset.py 50 datasets/regression/tier-b-synthetic.json
                    
                              # Seed after container is up so we can use its ffmpeg for golden samples
                              python3 scripts/manage.py seed \
                                --clean \
                                --dataset datasets/regression/tier-b-synthetic.json
                                        # Wait until the public endpoint returns real JSON payload
           (not startup/migration HTML).
          for i in {1..180}; do
            code="$(curl -s -o /tmp/jellyfin-public.json -w "%{http_code}" "http://localhost:8097/System/Info/Public" || true)"
            if [[ "${code}" == "200" ]] && grep -q '"Version"' /tmp/jellyfin-public.json; then
              break
            fi
            sleep 2
          done

          code="$(curl -s -o /tmp/jellyfin-public.json -w "%{http_code}" "http://localhost:8097/System/Info/Public" || true)"
          if [[ "${code}" != "200" ]] || ! grep -q '"Version"' /tmp/jellyfin-public.json; then
            echo "Jellyfin did not become healthy in time (last status: ${code})."
            echo "Last /System/Info/Public payload:"
            cat /tmp/jellyfin-public.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          # Route may briefly return startup/transient statuses while plugins finalize.
          endpoint_code=""
          for i in {1..90}; do
            endpoint_code="$(curl -s -o /tmp/shirarium-route.txt -w "%{http_code}" "http://localhost:8097/shirarium/organization-plan" || true)"
            if [[ "${endpoint_code}" == "401" || "${endpoint_code}" == "403" ]]; then
              break
            fi
            sleep 2
          done

          if [[ "${endpoint_code}" != "401" && "${endpoint_code}" != "403" ]]; then
            echo "Expected /shirarium/organization-plan to require auth (401/403), got ${endpoint_code}."
            cat /tmp/shirarium-route.txt || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          startup_completed="$(jq -r '.StartupWizardCompleted // false' /tmp/jellyfin-public.json | tr '[:upper:]' '[:lower:]')"

          if [[ "${startup_completed}" != "true" ]]; then
            echo '{"Name":"root","Password":"Passw0rd!","PasswordConfirm":"Passw0rd!"}' > /tmp/jellyfin-startup-user.json

            startup_user_ready_code=""
            for i in {1..120}; do
              startup_user_ready_code="$(curl -s -o /tmp/jellyfin-startup-user-get.json -w "%{http_code}" "${JELLYFIN_BASE_URL}/Startup/User" || true)"
              if [[ "${startup_user_ready_code}" == "200" ]]; then
                break
              fi
              sleep 1
            done

            if [[ "${startup_user_ready_code}" != "200" ]]; then
              echo "Startup user endpoint did not become ready. Last status: ${startup_user_ready_code}"
              cat /tmp/jellyfin-startup-user-get.json || true
              docker logs shirarium-jellyfin-dev || true
              exit 1
            fi

            startup_user_post_code="$(curl -s -o /tmp/jellyfin-startup-user-post.json -w "%{http_code}" \
              -X POST "${JELLYFIN_BASE_URL}/Startup/User" \
              -H "Content-Type: application/json" \
              --data-binary @/tmp/jellyfin-startup-user.json || true)"

            if [[ "${startup_user_post_code}" != "204" && "${startup_user_post_code}" != "200" ]]; then
              echo "Failed to configure startup user. Status: ${startup_user_post_code}"
              cat /tmp/jellyfin-startup-user-post.json || true
              docker logs shirarium-jellyfin-dev || true
              exit 1
            fi

            startup_complete_code="$(curl -s -o /tmp/jellyfin-startup-complete.out -w "%{http_code}" \
              -X POST "${JELLYFIN_BASE_URL}/Startup/Complete" || true)"

            if [[ "${startup_complete_code}" != "204" ]]; then
              echo "Failed to complete startup wizard. Status: ${startup_complete_code}"
              cat /tmp/jellyfin-startup-complete.out || true
              docker logs shirarium-jellyfin-dev || true
              exit 1
            fi
          fi

          echo '{"Username":"root","Pw":"Passw0rd!"}' > /tmp/jellyfin-auth.json

          auth_code=""
          for i in {1..120}; do
            auth_code="$(curl -s -o /tmp/jellyfin-auth-response.json -w "%{http_code}" \
              -X POST "${JELLYFIN_BASE_URL}/Users/AuthenticateByName" \
              -H "Content-Type: application/json" \
              -H "X-Emby-Authorization: MediaBrowser Client=Smoke, Device=CI, DeviceId=smoke-device, Version=1.0.0" \
              --data-binary @/tmp/jellyfin-auth.json || true)"
            if [[ "${auth_code}" == "200" ]]; then
              break
            fi
            sleep 1
          done

          if [[ "${auth_code}" != "200" ]]; then
            echo "Failed to authenticate bootstrap user. Last status: ${auth_code}"
            cat /tmp/jellyfin-auth-response.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          ACCESS_TOKEN="$(jq -r '.AccessToken // ""' /tmp/jellyfin-auth-response.json)"

          if [[ -z "${ACCESS_TOKEN}" ]]; then
            echo "Authentication response did not contain an access token."
            cat /tmp/jellyfin-auth-response.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          add_library_code="$(curl -s -o /tmp/jellyfin-add-library.out -w "%{http_code}" \
            -X POST "${JELLYFIN_BASE_URL}/Library/VirtualFolders?name=Media&collectionType=movies&paths=%2Fmedia&refreshLibrary=true" \
            -H "X-Emby-Token: ${ACCESS_TOKEN}" || true)"

          if [[ "${add_library_code}" != "204" && "${add_library_code}" != "200" ]]; then
            echo "Failed to add Media library. Status: ${add_library_code}"
            cat /tmp/jellyfin-add-library.out || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          library_visible="false"
          for i in {1..120}; do
            curl -s -o /tmp/jellyfin-virtual-folders.json -w "%{http_code}" \
              "${JELLYFIN_BASE_URL}/Library/VirtualFolders" \
              -H "X-Emby-Token: ${ACCESS_TOKEN}" > /tmp/jellyfin-virtual-folders-code.txt || true

            if [[ "$(cat /tmp/jellyfin-virtual-folders-code.txt)" == "200" ]]; then
              library_visible="$(jq -r 'any(.[]; .Locations | contains(["/media"]))' /tmp/jellyfin-virtual-folders.json)"
              if [[ "${library_visible}" == "true" ]]; then
                break
              fi
            fi
            sleep 1
          done

          if [[ "${library_visible}" != "true" ]]; then
            echo "Media library was not visible after creation."
            cat /tmp/jellyfin-virtual-folders.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          # Give the immediate library refresh a brief window before explicit scan polling.
          sleep 3

          non_empty_scan="false"
          for i in {1..60}; do
            scan_code="$(curl -s -o /tmp/shirarium-scan.json -w "%{http_code}" \
              -X POST "${JELLYFIN_BASE_URL}/shirarium/scan" \
              -H "X-Emby-Token: ${ACCESS_TOKEN}" || true)"
            if [[ "${scan_code}" == "200" ]]; then
              non_empty_scan="$(jq -r '(.CandidateCount | tonumber > 0) and (.ParsedCount | tonumber > 0) and (.Suggestions | length > 0)' /tmp/shirarium-scan.json)"
              if [[ "${non_empty_scan}" == "true" ]]; then
                break
              fi
            fi
            sleep 2
          done

          if [[ "${non_empty_scan}" != "true" ]]; then
            echo "Shirarium scan did not produce non-empty candidate/parsed/suggestion output."
            cat /tmp/shirarium-scan.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          plan_code="$(curl -s -o /tmp/shirarium-plan-organize.json -w "%{http_code}" \
            -X POST "${JELLYFIN_BASE_URL}/shirarium/plan-organize" \
            -H "X-Emby-Token: ${ACCESS_TOKEN}" || true)"

          if [[ "${plan_code}" != "200" ]]; then
            echo "Shirarium organization plan generation failed with status ${plan_code}."
            cat /tmp/shirarium-plan-organize.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          plan_snapshot_code="$(curl -s -o /tmp/shirarium-organization-plan.json -w "%{http_code}" \
            "${JELLYFIN_BASE_URL}/shirarium/organization-plan" \
            -H "X-Emby-Token: ${ACCESS_TOKEN}" || true)"

          if [[ "${plan_snapshot_code}" != "200" ]]; then
            echo "Failed to fetch organization plan snapshot. Status: ${plan_snapshot_code}"
            cat /tmp/shirarium-organization-plan.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          non_empty_plan="$(jq -r '(.PlannedCount | tonumber > 0) and (.Entries | length > 0)' /tmp/shirarium-organization-plan.json)"

          if [[ "${non_empty_plan}" != "true" ]]; then
            echo "Organization plan is empty after successful scan."
            cat /tmp/shirarium-organization-plan.json || true
            docker logs shirarium-jellyfin-dev || true
            exit 1
          fi

          if ! grep -a -q "Configuration.configPage.html" "src/Jellyfin.Plugin.Shirarium/bin/Release/net9.0/Jellyfin.Plugin.Shirarium.dll"; then
            echo "Plugin config page resource is missing from assembly."
            exit 1
          fi

          docker logs shirarium-jellyfin-dev | tail -n 200 || true
