<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Shirarium</title>
</head>
<body>
<div id="ShirariumReviewPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
            <style>
                .shirarium-container { padding: 20px 0; max-width: 900px; margin: 0 auto; }
                .sh-header { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
                .sh-header h1 { margin: 0; color: #33a1d6; font-weight: 300; font-size: 32px; }
                
                .sh-tabs { display: flex; gap: 5px; margin-bottom: 25px; }
                .sh-tab-btn { flex: 1; text-align: center; }

                .sh-card { background: #1c1c1c; border-radius: 8px; padding: 24px; margin-bottom: 20px; border: 1px solid #333; }
                .sh-card-title { font-size: 18px; margin-bottom: 15px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
                
                .sh-status-tag { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
                .status-ready { background: #27ae60; color: white; } /* Green */
                .status-fetching { background: #f1c40f; color: black; } /* Yellow */
                .status-booting { background: #33a1d6; color: white; } /* Blue */
                .status-error { background: #e74c3c; color: white; } /* Red */
                .status-offline { background: #444; color: #aaa; } /* Grey */
                
                .sh-table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 4px; border: 1px solid #333; }
                .sh-table { width: 100%; border-collapse: collapse; font-size: 13px; }
                .sh-table th { background: #222; text-align: left; padding: 12px; border-bottom: 1px solid #333; color: #888; }
                .sh-table td { padding: 12px; border-bottom: 1px solid #222; }
                
                .hidden { display: none !important; }
                .sh-btn-big { font-size: 1.2em !important; padding: 1em 2em !important; }
            </style>

            <div class="shirarium-container">
                <header class="sh-header">
                    <h1>Shirarium</h1>
                    <p style="color:#888; margin: 5px 0 0;">You like Jellyfin? You like order? You love Shirarium! <span style="color: #33a1d6;">❤️</span></p>
                </header>

                <div class="sh-tabs">
                    <button is="emby-button" class="sh-tab-btn raised active" data-tab="dash">Overview</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="review">Review Changes</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="settings">Settings</button>
                </div>

                <!-- DASHBOARD -->
                <div id="panel-dash" class="sh-panel">
                    <div class="sh-card">
                        <div class="sh-card-title">
                            <span>LLM Status</span>
                            <span id="ai-status-tag" class="sh-status-tag">Checking...</span>
                        </div>
                        <div id="ai-status-text">Connecting to local LLM...</div>
                        <div id="ai-progress-container" class="sh-table-wrap hidden" style="height: 8px; margin-top: 15px; background: #222; border: none;">
                            <div id="ai-progress-bar" style="width: 0%; height: 100%; background: #33a1d6; transition: width 0.4s ease;"></div>
                        </div>
                    </div>

                    <div id="card-ready" class="sh-card hidden" style="text-align: center;">
                        <h2 style="margin-top:0;">Good news!</h2>
                        <p id="ready-text">We found improvements for your library.</p>
                        <button is="emby-button" type="button" class="raised button-submit sh-btn-big" id="btn-start-review">
                            <span>Review Changes Now</span>
                        </button>
                    </div>

                    <div id="card-empty" class="sh-card">
                        <div class="sh-card-title">How to organize</div>
                        <p style="color:#aaa; line-height: 1.5;">
                            1. Run a <b>Library Scan</b> in your Jellyfin Dashboard.<br>
                            2. Our AI will analyze your files and propose better names.<br>
                            3. Return here to approve and apply the changes.
                        </p>
                    </div>
                </div>

                <!-- REVIEW -->
                <div id="panel-review" class="sh-panel hidden">
                    <div class="sh-card">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                            <div class="sh-card-title" style="margin:0;">Proposed Improvements</div>
                            <button is="emby-button" type="button" class="raised button-submit" id="btn-apply-main" disabled>
                                <span>Apply Selected</span>
                            </button>
                        </div>

                        <div class="sh-table-wrap">
                            <table class="sh-table">
                                <thead>
                                    <tr>
                                        <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                                        <th>Original File</th>
                                        <th>AI Suggestion</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div id="table-empty" class="hidden" style="padding:40px; text-align:center; color:#666;">
                            No files need organizing right now.
                        </div>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div id="panel-settings" class="sh-panel hidden">
                    <div class="sh-card">
                        <div class="sh-card-title">Settings</div>
                        <form id="settings-form">
                            <div class="checkboxContainer" style="margin:20px 0;">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableAi">
                                    <span>Enable Managed LLM</span>
                                </label>
                            </div>
                            <div class="selectContainer" style="margin:20px 0;">
                                <label class="form-label">LLM Model</label>
                                <select is="emby-select" id="selectPreset"></select>
                                <div id="preset-info" style="font-size:12px; color:#666; margin-top:5px;"></div>
                            </div>
                            <div style="margin-top:30px;">
                                <button is="emby-button" type="submit" class="raised button-submit">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var state = {
                pluginId: new URLSearchParams(window.location.search).get('id'),
                plan: null,
                selection: new Set()
            };

            function el(id) { return document.getElementById(id); }
            
                                                                        async function api(path, method, body) {
                                                                            var url = ApiClient.getUrl(path);
                                                                            try {
                                                                                return await ApiClient.ajax({
                                                                                    type: method || 'GET',
                                                                                    url: url,
                                                                                    data: body ? JSON.stringify(body) : null,
                                                                                    contentType: 'application/json',
                                                                                    dataType: 'json'
                                                                                });
                                                                            } catch (err) {
                                                                                console.error("[Shirarium] API Error:", path, err);
                                                                                throw err;
                                                                            }
                                                                        }
                                                            
                                                                        var state = {
                                                                            pluginId: '26639599-7389-408a-9860-310376d5423f',
                                                                            selection: new Set(),
                                                                            plan: null,
                                                                            isRefreshingDash: false
                                                                        };
                                                            
                                                                        async function refreshDash() {
                                                                            if (state.isRefreshingDash) return;
                                                                            state.isRefreshingDash = true;
                                                            
                                                                            try {
                                                                                var inf = await api('shirarium/inference-status');
                                                                                var plan = await api('shirarium/organization-plan-view?pageSize=1');
                                                                                state.plan = plan;
                                                            
                                                                                var tag = el('ai-status-tag');
                                                                                var progressContainer = el('ai-progress-container');
                                                                                var progressBar = el('ai-progress-bar');
                                                                                var statusText = el('ai-status-text');
                                                            
                                                                                                                        var status = inf.Status || 'Idle';
                                                                                                                        var rawModel = inf.ModelName || 'Managed LLM';
                                                                                                                        // Capitalize first letter of model name
                                                                                                                        var modelName = rawModel.charAt(0).toUpperCase() + rawModel.slice(1);
                                                                                                                        var progress = inf.Progress || 0;
                                                                                                                        var filtered = plan ? plan.FilteredEntries : 0;
                                                                                                    
                                                                                                                                            if (status === 'DownloadingModel') {
                                                                                                                                                tag.textContent = 'Fetching';
                                                                                                                                                tag.className = 'sh-status-tag status-fetching';
                                                                                                                                                statusText.textContent = 'Downloading: ' + modelName;
                                                                                                                                                if (progressContainer) progressContainer.classList.remove('hidden');
                                                                                                                                                if (progressBar) progressBar.style.width = progress + '%';
                                                                                                                                            } else if (status === 'Initializing') {
                                                                                                                                                tag.textContent = 'Booting';
                                                                                                                                                tag.className = 'sh-status-tag status-booting';
                                                                                                                                                statusText.textContent = 'Starting LLM process...';
                                                                                                                                                if (progressContainer) progressContainer.classList.add('hidden');
                                                                                                                                            } else if (status === 'Ready') {
                                                                                                                                                tag.textContent = 'Loaded';
                                                                                                                                                tag.className = 'sh-status-tag status-ready';
                                                                                                                                                statusText.textContent = 'Model: ' + modelName;
                                                                                                                                                if (progressContainer) progressContainer.classList.add('hidden');
                                                                                                                                            } else if (status === 'Error') {
                                                                                                                                                tag.textContent = 'Failed';
                                                                                                                                                tag.className = 'sh-status-tag status-error';
                                                                                                                                                statusText.textContent = 'Engine error: ' + (inf.Error || 'Critical failure');
                                                                                                                                                if (progressContainer) progressContainer.classList.add('hidden');
                                                                                                                                            } else {
                                                                                                                                                tag.textContent = 'Offline';
                                                                                                                                                tag.className = 'sh-status-tag status-offline';
                                                                                                                                                statusText.textContent = 'Engine is ' + (status || 'idle').toLowerCase() + '.';
                                                                                                                                                if (progressContainer) progressContainer.classList.add('hidden');
                                                                                                                                            }                                                                                if (filtered > 0) {
                                                                                    el('card-ready').classList.remove('hidden');
                                                                                    el('ready-text').textContent = 'AI found ' + filtered + ' improvements for your library.';
                                                                                } else {
                                                                                    el('card-ready').classList.add('hidden');
                                                                                }
                                                                            } catch (e) {
                                                                                console.error("[Shirarium] Dash update failed", e);
                                                                            } finally {
                                                                                state.isRefreshingDash = false;
                                                                            }
                                                                        }                                        function switchTab(tabId) {
                                            console.log("[Shirarium] Switching to tab:", tabId);
                                            document.querySelectorAll('.sh-tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tabId); });
                                            document.querySelectorAll('.sh-panel').forEach(function(p) { p.classList.toggle('hidden', p.id !== 'panel-' + tabId); });
                                            if (tabId === 'dash') refreshDash();
                                            if (tabId === 'review') refreshReview();
                                            if (tabId === 'settings') loadSettings();
                                        }
                            
                                                    async function refreshReview() {
                                                        Dashboard.showLoadingMsg();
                                                        try {
                                                            var plan = await api('shirarium/organization-plan-view?pageSize=100');
                                                            state.plan = plan;
                                                            state.selection.clear();
                                                            el('selectAll').checked = false;
                                        
                                                            var tbody = el('table-body');
                                                            tbody.innerHTML = '';
                                        
                                                            if (!plan.Entries || plan.Entries.length === 0) {
                                                                el('table-empty').classList.remove('hidden');
                                                                el('btn-apply-main').disabled = true;
                                                                return;
                                                            }
                                        
                                                            el('table-empty').classList.add('hidden');
                                                            el('btn-apply-main').disabled = true;
                                        
                                                            plan.Entries.forEach(function(entry) {
                                                                var row = document.createElement('tr');
                                                                row.innerHTML = '<td><input type="checkbox" class="row-check" data-path="' + entry.SourcePath + '"></td>' +
                                                                    '<td><div style="font-family:monospace; font-size:11px; word-break:break-all;">' + entry.SourcePath + '</div></td>' +
                                                                    '<td><div style="color:#33a1d6; word-break:break-all;">' + (entry.EffectiveTargetPath || '-') + '</div></td>';
                                                                tbody.appendChild(row);
                                                            });
                                        
                                                            tbody.querySelectorAll('.row-check').forEach(function(chk) {
                                                                chk.addEventListener('change', function(e) {
                                                                    if (e.target.checked) state.selection.add(e.target.dataset.path);
                                                                    else state.selection.delete(e.target.dataset.path);
                                                                    el('btn-apply-main').disabled = state.selection.size === 0;
                                                                });
                                                            });
                                                        } catch (e) {
                                                            console.error("[Shirarium] Review refresh failed", e);
                                                        } finally { Dashboard.hideLoadingMsg(); }
                                                    }
                                        
                                                    async function loadSettings() {
                                                        try {
                                                            var config = await ApiClient.getPluginConfiguration(state.pluginId);
                                                            var presets = await api('shirarium/ai-model-presets');
                                        
                                                            el('chkEnableAi').checked = config.EnableAiParsing;
                                                            var sel = el('selectPreset');
                                                            sel.innerHTML = presets.Presets.map(function(p) {
                                                                return '<option value="' + p.Id + '" ' + (p.Id === config.SelectedModelPreset ? 'selected' : '') + '>' + p.Name + '</option>';
                                                            }).join('');
                                        
                                                            var updateInfo = function() {
                                                                var p = presets.Presets.find(function(x) { return x.Id === sel.value; });
                                                                if (p) el('preset-info').textContent = p.Rationale;
                                                            };
                                                            sel.onchange = updateInfo;
                                                            updateInfo();
                                                            state.config = config;
                                                        } catch(e) {
                                                            console.error("[Shirarium] Settings load failed", e);
                                                        }
                                                    }
                                        
                                                    async function saveSettings(e) {
                                                        e.preventDefault();
                                                        Dashboard.showLoadingMsg();
                                                        try {
                                                            state.config.EnableAiParsing = el('chkEnableAi').checked;
                                                            state.config.SelectedModelPreset = el('selectPreset').value;
                                                            await ApiClient.updatePluginConfiguration(state.pluginId, state.config);
                                                            Dashboard.alert('Settings saved.');
                                                        } finally { Dashboard.hideLoadingMsg(); }
                                                    }
                                        
                                                    async function applySelected() {
                                                        if (state.selection.size === 0) return;
                                                        Dashboard.showLoadingMsg();
                                                        try {
                                                            await api('shirarium/apply-reviewed-plan', 'POST', {
                                                                expectedPlanFingerprint: state.plan.PlanFingerprint,
                                                                sourcePaths: Array.from(state.selection)
                                                            });
                                                            Dashboard.alert('Library updated!');
                                                            refreshReview();
                                                        } catch(e) { 
                                                            console.error("[Shirarium] Apply failed", e);
                                                            Dashboard.alert('Failed: ' + e.message); 
                                                        } finally { Dashboard.hideLoadingMsg(); }
                                                    }
                        // Polling logic
                        var pollHandle = null;
                        function startPolling() {
                            if (pollHandle) {
                                console.log("[Shirarium] Polling already active");
                                return;
                            }
                            console.log("[Shirarium] Starting polling interval");
                            pollHandle = setInterval(function() {
                                if (!el('panel-dash').classList.contains('hidden')) {
                                    refreshDash();
                                }
                            }, 3000);
                        }
            
                        var isInitialized = false;
                        function init() {
                            if (isInitialized) {
                                console.log("[Shirarium] Already initialized, skipping");
                                return;
                            }
                            isInitialized = true;
                            console.log("[Shirarium] Initializing dashboard for the first time...");
                            refreshDash();
                            startPolling();
                        }
            
                        // INIT - Fallback to immediate init if page events don't fire
                        console.log("[Shirarium] Script loaded, binding events...");
                        var page = document.querySelector('#ShirariumReviewPage');
                        if (page) {
                            console.log("[Shirarium] Found page, binding events");
                            page.addEventListener('pageshow', init);
                            page.addEventListener('viewshow', init);
                            // Force init after a short delay to ensure everything is ready
                            setTimeout(init, 800);
                        } else {
                            console.warn("[Shirarium] Could not find #ShirariumReviewPage, initializing anyway...");
                            init();
                        }
            document.querySelectorAll('.sh-tab-btn').forEach(function(btn) {
                btn.onclick = function() { switchTab(btn.dataset.tab); };
            });
            
            el('btn-start-review').onclick = function() { switchTab('review'); };
            el('btn-apply-main').onclick = applySelected;
            el('settings-form').onsubmit = saveSettings;
            el('selectAll').onclick = function(e) {
                document.querySelectorAll('.row-check').forEach(function(chk) {
                    chk.checked = e.target.checked;
                    if (e.target.checked) state.selection.add(chk.dataset.path);
                    else state.selection.delete(chk.dataset.path);
                });
                el('btn-apply-main').disabled = state.selection.size === 0;
            };

        })();
    </script>
</div>
</body>
</html>