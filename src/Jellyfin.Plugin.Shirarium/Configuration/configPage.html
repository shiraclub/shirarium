<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Shirarium</title>
</head>
<body>
<div id="ShirariumReviewPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
                        <style>
                            .shirarium-container { padding: 20px 0; max-width: 1400px; width: 95%; margin: 0 auto; transition: max-width 0.3s ease; }
                            .sh-header { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
                            .sh-header h1 { margin: 0; color: #33a1d6; font-weight: 300; font-size: 32px; }
            
                            .sh-tabs { display: flex; gap: 5px; margin-bottom: 25px; }
                            .sh-tab-btn { flex: 1; text-align: center; }
            
                            .sh-card { background: #1c1c1c; border-radius: 8px; padding: 24px; margin-bottom: 20px; border: 1px solid #333; }
                            .sh-card-title { font-size: 18px; margin-bottom: 15px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
            
                            .sh-status-tag { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
                            .status-ready { background: #27ae60; color: white; }
                            .status-fetching { background: #f1c40f; color: black; }
                            .status-booting { background: #33a1d6; color: white; }
                            .status-error { background: #e74c3c; color: white; }
                            .status-offline { background: #444; color: #aaa; }
            
                            .sh-metadata { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }  
                            .sh-meta-item { background: #222; padding: 10px; border-radius: 4px; border: 1px solid #333; }
                            .sh-meta-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 4px; }
                            .sh-meta-value { font-size: 13px; color: #33a1d6; font-family: monospace; }
            
                            .sh-table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 4px; border: 1px solid #333; }
                            .sh-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
                            .sh-table th { background: #222; text-align: left; padding: 12px; border-bottom: 1px solid #333; color: #888; }
                            .sh-table td { padding: 12px; border-bottom: 1px solid #222; vertical-align: top; }
                            
                            .col-check { width: 40px; }
                            .col-original { width: 35%; }
                            .col-suggestion { width: auto; }
                            /* Terminal Styling */
                .sh-terminal { background: #000; border-radius: 4px; padding: 15px; font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 11px; line-height: 1.4; color: #33a1d6; border: 1px solid #111; height: 180px; overflow-y: auto; box-shadow: inset 0 0 10px rgba(51, 161, 214, 0.1); margin-top: 15px; }
                .sh-terminal-line { margin-bottom: 2px; border-left: 2px solid transparent; padding-left: 8px; }
                .sh-terminal-line:hover { border-left-color: #33a1d6; background: rgba(51, 161, 214, 0.05); }
                .sh-terminal-tag { color: #888; margin-right: 8px; }
                .sh-terminal::-webkit-scrollbar { width: 4px; }
                .sh-terminal::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

                /* Diffing Styling */
                .diff-added { background: rgba(39, 174, 96, 0.2); color: #2ecc71; padding: 0 2px; border-radius: 2px; text-decoration: none; }
                .diff-removed { background: rgba(231, 76, 60, 0.2); color: #e74c3c; padding: 0 2px; border-radius: 2px; text-decoration: line-through; opacity: 0.8; }
                .diff-wrap { font-family: monospace; font-size: 11px; word-break: break-all; white-space: pre-wrap; }

                .hidden { display: none !important; }
                .sh-btn-big { font-size: 1.2em !important; padding: 1em 2em !important; }
            </style>

            <div class="shirarium-container">
                <header class="sh-header">
                    <h1>Shirarium</h1>
                    <p style="color:#888; margin: 5px 0 0;">You like Jellyfin? You like order? You love Shirarium! <span style="color: #33a1d6;">❤️</span></p>
                </header>

                <div class="sh-tabs">
                    <button is="emby-button" class="sh-tab-btn raised active" data-tab="dash">Overview</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="review">Review Changes</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="settings">Settings</button>
                </div>

                <!-- DASHBOARD -->
                <div id="panel-dash" class="sh-panel">
                    <div class="sh-card">
                        <div class="sh-card-title">
                            <span>LLM Status</span>
                            <span id="ai-status-tag" class="sh-status-tag">Checking...</span>
                        </div>
                        <div id="ai-status-text">Connecting to local LLM...</div>
                        <div id="ai-metadata" class="sh-metadata hidden"></div>
                        <div id="ai-progress-container" class="sh-table-wrap hidden" style="height: 8px; margin-top: 15px; background: #222; border: none;">
                            <div id="ai-progress-bar" style="width: 0%; height: 100%; background: #33a1d6; transition: width 0.4s ease;"></div>
                        </div>
                    </div>

                    <div id="card-terminal" class="sh-card hidden">
                        <div class="sh-card-title">Thinking Stream</div>
                        <div id="ai-logs" class="sh-terminal">
                            <div class="sh-terminal-line">Waiting for engine output...</div>
                        </div>
                    </div>

                    <div id="card-ready" class="sh-card hidden" style="text-align: center;">
                        <h2 style="margin-top:0;">Good news!</h2>
                        <p id="ready-text">Shirarium found improvements for your library.</p>
                        <button is="emby-button" type="button" class="raised button-submit sh-btn-big" id="btn-start-review">
                            <span>Review Changes Now</span>
                        </button>
                    </div>

                    <div id="card-empty" class="sh-card">
                        <div class="sh-card-title">How to organize</div>
                        <p style="color:#aaa; line-height: 1.5;">
                            1. Run a <b>Library Scan</b> in your Jellyfin Dashboard.<br>
                            2. Shirarium will analyze your files and propose better names.<br>
                            3. Return here to approve and apply the changes.
                        </p>
                    </div>
                </div>

                <!-- REVIEW -->
                <div id="panel-review" class="sh-panel hidden">
                    <div class="sh-card">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                            <div class="sh-card-title" style="margin:0;">Proposed Improvements</div>
                            <button is="emby-button" type="button" class="raised button-submit" id="btn-apply-main" disabled>
                                <span>Apply Selected</span>
                            </button>
                        </div>

                        <div class="sh-table-wrap">
                            <table class="sh-table">
                                <thead>
                                    <tr>
                                        <th class="col-check"><input type="checkbox" id="selectAll"></th>
                                        <th class="col-original">Original File</th>
                                        <th class="col-suggestion">Shirarium Suggestion</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                </tbody>
                            </table>
                        </div>
                        <div id="table-empty" class="hidden" style="padding:40px; text-align:center; color:#666;">
                            No files need organizing right now.
                        </div>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div id="panel-settings" class="sh-panel hidden">
                    <div class="sh-card">
                        <div class="sh-card-title">Parsing Engines</div>
                        <form id="settings-form">
                            <div class="checkboxContainer" style="margin:20px 0;">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableHeuristics">
                                    <span>Enable Heuristics</span>
                                </label>
                                <div class="fieldDescription">Instant pattern matching. CPU-friendly and works for 90% of standard filenames.</div>
                            </div>

                            <div class="checkboxContainer" style="margin:20px 0;">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableAi">
                                    <span>Enable LLM (Large Language Model)</span>
                                </label>
                                <div class="fieldDescription">Deeper analysis for "impossible" filenames (Anime, scene soup, hashes). Requires extra RAM.</div>
                            </div>

                            <div id="llm-details" class="hidden" style="margin-left: 20px; border-left: 2px solid #333; padding-left: 20px;">
                                <div class="selectContainer" style="margin:20px 0;">
                                    <label class="form-label">LLM Model</label>
                                    <select is="emby-select" id="selectPreset"></select>
                                    <div id="preset-info" style="font-size:12px; color:#666; margin-top:5px;"></div>
                                </div>
                                <div id="custom-model-container" class="hidden" style="margin:20px 0;">
                                    <div class="inputContainer">
                                        <input is="emby-input" type="text" id="txtCustomUrl" label="Custom GGUF URL" placeholder="https://huggingface.co/.../model.gguf" />
                                        <div class="fieldDescription">
                                            Paste a direct <b>GGUF</b> download link. 
                                            <a href="https://huggingface.co/models?search=gguf" target="_blank" style="color: #33a1d6; text-decoration: none;">Find models on Hugging Face &rarr;</a><br/>
                                            <div style="margin-top:5px; opacity: 0.8;">Tip: Models between 1B and 4B parameters (like Llama 3.2 or Qwen 2.5) offer the best balance of speed and accuracy for Shirarium.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:30px;">
                                <button is="emby-button" type="submit" class="raised button-submit">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var BF_ID = 'f8f6424f-3316-47ef-bfbe-b8138f7ef3ab';
            var pluginId = new URLSearchParams(window.location.search).get('id') || 
                           new URLSearchParams(window.location.hash.split('?')[1] || '').get('id') || 
                           BF_ID;

            var state = {
                pluginId: pluginId,
                selection: new Set(),
                plan: null,
                isRefreshingDash: false
            };

            function el(id) { return document.getElementById(id); }

            async function api(path, method, body) {
                var url = ApiClient.getUrl(path);
                try {
                    return await ApiClient.ajax({
                        type: method || 'GET',
                        url: url,
                        data: body ? JSON.stringify(body) : null,
                        contentType: 'application/json',
                        dataType: 'json'
                    });
                } catch (err) {
                    console.error("[Shirarium] API Error:", path, err);
                    throw err;
                }
            }

            async function refreshLogs() {
                try {
                    var logs = await api('shirarium/inference-logs');
                    var container = el('ai-logs');
                    if (!logs || logs.length === 0) return;

                    var html = logs.map(function(line) {
                        return '<div class="sh-terminal-line">' + 
                               '<span class="sh-terminal-tag">&gt;</span>' + 
                               line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                               '</div>';
                    }).join('');

                    var isAtBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
                    container.innerHTML = html;
                    if (isAtBottom) container.scrollTop = container.scrollHeight;

                    el('card-terminal').classList.remove('hidden');
                } catch (e) { console.error("[Shirarium] Log refresh failed", e); }
            }

            async function refreshDash() {
                if (state.isRefreshingDash) return;
                state.isRefreshingDash = true;

                try {
                    var inf = await api('shirarium/inference-status');
                    var plan = await api('shirarium/organization-plan-view?pageSize=1');
                    state.plan = plan;

                    var tag = el('ai-status-tag');
                    var progressContainer = el('ai-progress-container');
                    var progressBar = el('ai-progress-bar');
                    var statusText = el('ai-status-text');
                    var metaContainer = el('ai-metadata');

                    var status = inf.Status || 'Idle';
                    var rawModel = inf.ModelName || 'Managed LLM';
                    var modelName = rawModel.charAt(0).toUpperCase() + rawModel.slice(1);
                    var progress = inf.Progress || 0;
                    var filtered = plan ? plan.FilteredEntries : 0;

                    if (status === 'Ready' || status === 'Initializing' || status === 'DownloadingModel') {
                        refreshLogs();
                    } else {
                        el('card-terminal').classList.add('hidden');
                    }

                    if (inf.Metadata && Object.keys(inf.Metadata).length > 0) {
                        metaContainer.classList.remove('hidden');
                        metaContainer.innerHTML = Object.keys(inf.Metadata).map(function(k) {
                            return '<div class="sh-meta-item">' +
                                '<div class="sh-meta-label">' + k + '</div>' +
                                '<div class="sh-meta-value">' + inf.Metadata[k] + '</div>' +
                                '</div>';
                        }).join('');
                        if (status === 'Ready') statusText.classList.add('hidden');
                        else statusText.classList.remove('hidden');
                    } else {
                        metaContainer.classList.add('hidden');
                        statusText.classList.remove('hidden');
                    }

                    if (status === 'DownloadingModel') {                                                  
                        tag.textContent = 'Fetching';
                        tag.className = 'sh-status-tag status-fetching';
                        statusText.textContent = 'Downloading: ' + modelName;
                        if (progressContainer) progressContainer.classList.remove('hidden');
                        if (progressBar) progressBar.style.width = progress + '%';
                    } else if (status === 'Initializing') {       
                        tag.textContent = 'Booting';
                        tag.className = 'sh-status-tag status-booting';
                        statusText.textContent = 'Starting LLM process...';
                        if (progressContainer) progressContainer.classList.add('hidden');
                    } else if (status === 'Ready') {
                        tag.textContent = 'Loaded';
                        tag.className = 'sh-status-tag status-ready';
                        statusText.textContent = 'Model: ' + modelName;
                        if (progressContainer) progressContainer.classList.add('hidden');
                    } else if (status === 'Error') {
                        tag.textContent = 'Failed';
                        tag.className = 'sh-status-tag status-error';
                        statusText.textContent = 'Engine error: ' + (inf.Error || 'Critical failure');
                        if (progressContainer) progressContainer.classList.add('hidden');
                    } else {
                        tag.textContent = 'Offline';
                        tag.className = 'sh-status-tag status-offline';
                        statusText.textContent = 'Engine is ' + (status || 'idle').toLowerCase() + '.';
                        if (progressContainer) progressContainer.classList.add('hidden');
                    }                                             

                    if (filtered > 0) {
                        el('card-ready').classList.remove('hidden');
                        el('ready-text').textContent = 'Shirarium found ' + filtered + ' improvements for your library.';     
                    } else {
                        el('card-ready').classList.add('hidden');
                    }
                } catch (e) {
                    console.error("[Shirarium] Dash update failed", e);
                } finally {
                    state.isRefreshingDash = false;
                }
            }

            function switchTab(tabId) {
                document.querySelectorAll('.sh-tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tabId); });
                document.querySelectorAll('.sh-panel').forEach(function(p) { p.classList.toggle('hidden', p.id !== 'panel-' + tabId); });
                
                // Maximize space for Review panel
                var container = document.querySelector('.shirarium-container');
                if (tabId === 'review') {
                    container.style.maxWidth = '100%';
                } else {
                    container.style.maxWidth = '1400px';
                }

                if (tabId === 'dash') refreshDash();
                if (tabId === 'review') refreshReview();
                if (tabId === 'settings') loadSettings();
            }

                        function diffStrings(oldStr, newStr) {
                            if (!oldStr || !newStr) return newStr || '-';
                            
                            // For paths, let's try a segment-based diff first (split by / or \)
                            var a = oldStr.split(/[\\\/]/);
                            var b = newStr.split(/[\\\/]/);
                            var html = '';
                            
                            // If the paths are vastly different (e.g. different roots), just show the new one
                            if (a[0] !== b[0] && a.length > 1 && b.length > 1) {
                                return '<span class="diff-added">' + newStr + '</span>';
                            }
            
                            // Simple word-level diff for the filename (last segment)
                            for (var i = 0; i < Math.max(a.length, b.length); i++) {
                                if (i > 0) html += ' / ';
                                
                                if (i >= a.length) {
                                    html += '<span class="diff-added">' + b[i] + '</span>';
                                } else if (i >= b.length) {
                                    html += '<span class="diff-removed">' + a[i] + '</span>';
                                } else if (a[i] === b[i]) {
                                    html += a[i];
                                } else {
                                    // Different segment - do char-level diff for this segment
                                    var sa = a[i], sb = b[i];
                                    var segmentHtml = '';
                                    var j = 0;
                                    while(j < Math.min(sa.length, sb.length) && sa[j] === sb[j]) {
                                        segmentHtml += sa[j];
                                        j++;
                                    }
                                    if (j < sa.length) segmentHtml += '<span class="diff-removed">' + sa.substring(j) + '</span>';
                                    if (j < sb.length) segmentHtml += '<span class="diff-added">' + sb.substring(j) + '</span>';
                                    html += segmentHtml;
                                }
                            }
                            return html;
                        }
            
                        async function refreshReview() {
                            Dashboard.showLoadingMsg();
                            try {
                                var plan = await api('shirarium/organization-plan-view?pageSize=100');
                                state.plan = plan;
                                state.selection.clear();
                                el('selectAll').checked = false;
            
                                var tbody = el('table-body');
                                tbody.innerHTML = '';
            
                                if (!plan.Entries || plan.Entries.length === 0) {
                                    el('table-empty').classList.remove('hidden');
                                    el('btn-apply-main').disabled = true;
                                    return;
                                }
            
                                el('table-empty').classList.add('hidden');
                                el('btn-apply-main').disabled = true;
            
                                plan.Entries.forEach(function(entry) {
                                    var row = document.createElement('tr');
                                    var diffHtml = diffStrings(entry.SourcePath, entry.EffectiveTargetPath);
                                    row.innerHTML = '<td><input type="checkbox" class="row-check" data-path="' + entry.SourcePath + '"></td>' +
                                        '<td><div style="font-family:monospace; font-size:11px; word-break:break-all; opacity:0.6;">' + entry.SourcePath + '</div></td>' +
                                        '<td><div class="diff-wrap">' + diffHtml + '</div></td>';
                                    tbody.appendChild(row);
                                });
                                tbody.querySelectorAll('.row-check').forEach(function(chk) {
                        chk.addEventListener('change', function(e) {
                            if (e.target.checked) state.selection.add(e.target.dataset.path);
                            else state.selection.delete(e.target.dataset.path);
                            el('btn-apply-main').disabled = state.selection.size === 0;
                        });
                    });
                } catch (e) {
                    console.error("[Shirarium] Review refresh failed", e);
                } finally { Dashboard.hideLoadingMsg(); }
            }

            async function loadSettings() {
                try {
                    var config = await ApiClient.getPluginConfiguration(state.pluginId);     
                    var presets = await api('shirarium/ai-model-presets');

                    el('chkEnableHeuristics').checked = config.EnableHeuristics !== false; 
                    el('chkEnableAi').checked = config.EnableManagedLocalInference;
                    el('txtCustomUrl').value = config.CustomModelUrl || '';

                    var updateLlmVisibility = function() {
                        if (el('chkEnableAi').checked) el('llm-details').classList.remove('hidden');
                        else el('llm-details').classList.add('hidden');
                    };
                    el('chkEnableAi').onchange = updateLlmVisibility;
                    updateLlmVisibility();

                    var sel = el('selectPreset');
                    sel.innerHTML = (presets.Presets || []).map(function(p) {
                        var id = p.Id || p.id;
                        var name = p.Name || p.name;
                        return '<option value="' + id + '" ' + (id === config.SelectedModelPreset ? 'selected' : '') + '>' + name + '</option>';
                    }).join('');

                    var updateInfo = function() {
                        var val = sel.value;
                        var p = (presets.Presets || []).find(function(x) { return (x.Id || x.id) === val; });
                        if (p) el('preset-info').textContent = p.Rationale || p.rationale;
                        
                        if (val === 'custom') el('custom-model-container').classList.remove('hidden');
                        else el('custom-model-container').classList.add('hidden');
                    };
                    sel.onchange = updateInfo;
                    updateInfo();
                    state.config = config;
                } catch(e) {
                    console.error("[Shirarium] Settings load failed", e);
                }
            }

            async function saveSettings(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                try {
                    state.config.EnableHeuristics = el('chkEnableHeuristics').checked;
                    state.config.EnableManagedLocalInference = el('chkEnableAi').checked;
                    state.config.EnableAiParsing = el('chkEnableAi').checked;

                    var selectedId = el('selectPreset').value;
                    state.config.SelectedModelPreset = selectedId;
                    state.config.CustomModelUrl = el('txtCustomUrl').value;
                    
                    var presets = await api('shirarium/ai-model-presets');
                    var p = (presets.Presets || []).find(function(x) { return (x.Id || x.id) === selectedId; });
                    if (p && p.Url) state.config.ModelUrl = p.Url || p.url;
                    
                    await ApiClient.updatePluginConfiguration(state.pluginId, state.config);
                    Dashboard.alert('Settings saved.');
                } catch (e) {
                    console.error("[Shirarium] Save failed", e);
                } finally { Dashboard.hideLoadingMsg(); }
            }

            async function applySelected() {
                if (state.selection.size === 0) return;
                Dashboard.showLoadingMsg();
                try {
                    await api('shirarium/apply-reviewed-plan', 'POST', {
                        expectedPlanFingerprint: state.plan.PlanFingerprint,
                        sourcePaths: Array.from(state.selection)
                    });
                    Dashboard.alert('Library updated!');
                    refreshReview();
                } catch(e) {
                    console.error("[Shirarium] Apply failed", e);
                    Dashboard.alert('Failed: ' + e.message);
                } finally { Dashboard.hideLoadingMsg(); }
            }

            var pollHandle = null;
            function startPolling() {
                if (pollHandle) return;
                pollHandle = setInterval(function() {
                    if (!el('panel-dash').classList.contains('hidden')) {
                        refreshDash();
                    }
                }, 3000);
            }

            var isInitialized = false;
            function init() {
                if (isInitialized) return;
                isInitialized = true;
                refreshDash();
                startPolling();
            }

            var page = document.querySelector('#ShirariumReviewPage');
            if (page) {
                page.addEventListener('pageshow', init);
                page.addEventListener('viewshow', init);
                setTimeout(init, 800);
            } else {
                init();
            }

            document.querySelectorAll('.sh-tab-btn').forEach(function(btn) {
                btn.onclick = function() { switchTab(btn.dataset.tab); };
            });

            el('btn-start-review').onclick = function() { switchTab('review'); };
            el('btn-apply-main').onclick = applySelected;
            el('settings-form').onsubmit = saveSettings;
            el('selectAll').onclick = function(e) {
                document.querySelectorAll('.row-check').forEach(function(chk) {
                    chk.checked = e.target.checked;
                    if (e.target.checked) state.selection.add(chk.dataset.path);
                    else state.selection.delete(chk.dataset.path);
                });
                el('btn-apply-main').disabled = state.selection.size === 0;
            };
        })();
    </script>
</div>
</body>
</html>
