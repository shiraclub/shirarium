<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Shirarium</title>
</head>
<body>
<div id="ShirariumReviewPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
        <div class="content-primary">
            <style>
                .shirarium-container { padding: 20px 0; max-width: 900px; margin: 0 auto; }
                .sh-header { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
                .sh-header h1 { margin: 0; color: #52B54B; font-weight: 300; font-size: 32px; }
                
                .sh-tabs { display: flex; gap: 5px; margin-bottom: 25px; }
                .sh-tab-btn { flex: 1; text-align: center; }

                .sh-card { background: #1c1c1c; border-radius: 8px; padding: 24px; margin-bottom: 20px; border: 1px solid #333; }
                .sh-card-title { font-size: 18px; margin-bottom: 15px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
                
                .sh-status-tag { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
                .status-ok { background: #52B54B; color: white; }
                .status-wait { background: #f1c40f; color: black; }
                
                .sh-table-wrap { overflow-x: auto; margin-top: 15px; border-radius: 4px; border: 1px solid #333; }
                .sh-table { width: 100%; border-collapse: collapse; font-size: 13px; }
                .sh-table th { background: #222; text-align: left; padding: 12px; border-bottom: 1px solid #333; color: #888; }
                .sh-table td { padding: 12px; border-bottom: 1px solid #222; }
                
                .hidden { display: none !important; }
                .sh-btn-big { font-size: 1.2em !important; padding: 1em 2em !important; }
            </style>

            <div class="shirarium-container">
                <header class="sh-header">
                    <h1>Shirarium</h1>
                    <p style="color:#888; margin: 5px 0 0;">Intelligent Library Organizer</p>
                </header>

                <div class="sh-tabs">
                    <button is="emby-button" class="sh-tab-btn raised active" data-tab="dash">Overview</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="review">Review Changes</button>
                    <button is="emby-button" class="sh-tab-btn raised" data-tab="settings">Settings</button>
                </div>

                <!-- DASHBOARD -->
                <div id="panel-dash" class="sh-panel">
                    <div class="sh-card">
                        <div class="sh-card-title">
                            <span>AI Brain Status</span>
                            <span id="ai-status-tag" class="sh-status-tag">Checking...</span>
                        </div>
                        <div id="ai-status-text">Connecting to local AI engine...</div>
                    </div>

                    <div id="card-ready" class="sh-card hidden" style="text-align: center;">
                        <h2 style="margin-top:0;">Good news!</h2>
                        <p id="ready-text">We found improvements for your library.</p>
                        <button is="emby-button" type="button" class="raised button-submit sh-btn-big" id="btn-start-review">
                            <span>Review Changes Now</span>
                        </button>
                    </div>

                    <div id="card-empty" class="sh-card">
                        <div class="sh-card-title">How to organize</div>
                        <p style="color:#aaa; line-height: 1.5;">
                            1. Run a <b>Library Scan</b> in your Jellyfin Dashboard.<br>
                            2. Our AI will analyze your files and propose better names.<br>
                            3. Return here to approve and apply the changes.
                        </p>
                    </div>
                </div>

                <!-- REVIEW -->
                <div id="panel-review" class="sh-panel hidden">
                    <div class="sh-card">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                            <div class="sh-card-title" style="margin:0;">Proposed Improvements</div>
                            <button is="emby-button" type="button" class="raised button-submit" id="btn-apply-main" disabled>
                                <span>Apply Selected</span>
                            </button>
                        </div>

                        <div class="sh-table-wrap">
                            <table class="sh-table">
                                <thead>
                                    <tr>
                                        <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                                        <th>Original File</th>
                                        <th>AI Suggestion</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                        <div id="table-empty" class="hidden" style="padding:40px; text-align:center; color:#666;">
                            No files need organizing right now.
                        </div>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div id="panel-settings" class="sh-panel hidden">
                    <div class="sh-card">
                        <div class="sh-card-title">Settings</div>
                        <form id="settings-form">
                            <div class="checkboxContainer" style="margin:20px 0;">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableAi">
                                    <span>Enable AI Brain</span>
                                </label>
                            </div>
                            <div class="selectContainer" style="margin:20px 0;">
                                <label class="form-label">AI Model</label>
                                <select is="emby-select" id="selectPreset"></select>
                                <div id="preset-info" style="font-size:12px; color:#666; margin-top:5px;"></div>
                            </div>
                            <div style="margin-top:30px;">
                                <button is="emby-button" type="submit" class="raised button-submit">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var state = {
                pluginId: new URLSearchParams(window.location.search).get('id'),
                plan: null,
                selection: new Set()
            };

            function el(id) { return document.getElementById(id); }
            
            function api(path, method, body) {
                return new Promise(function(resolve, reject) {
                    ApiClient.ajax({
                        type: method || 'GET',
                        url: ApiClient.getUrl(path),
                        data: body ? JSON.stringify(body) : null,
                        contentType: 'application/json',
                        dataType: 'json',
                        success: resolve,
                        error: reject
                    });
                });
            }

            function switchTab(tabId) {
                document.querySelectorAll('.sh-tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tabId); });
                document.querySelectorAll('.sh-panel').forEach(function(p) { p.classList.toggle('hidden', p.id !== 'panel-' + tabId); });
                if (tabId === 'dash') refreshDash();
                if (tabId === 'review') refreshReview();
                if (tabId === 'settings') loadSettings();
            }

            async function refreshDash() {
                try {
                    var results = await Promise.all([
                        api('shirarium/inference-status'),
                        api('shirarium/organization-plan-view?pageSize=1')
                    ]);
                    
                    var inf = results[0];
                    var plan = results[1];
                    state.plan = plan;

                    var tag = el('ai-status-tag');
                    if (inf.isDownloading) {
                        tag.textContent = 'Learning...';
                        tag.className = 'sh-status-tag status-wait';
                        el('ai-status-text').textContent = 'AI is downloading its knowledge (' + (inf.downloadProgress || 0) + '%).';
                    } else if (inf.isOnline) {
                        tag.textContent = 'Active';
                        tag.className = 'sh-status-tag status-ok';
                        el('ai-status-text').textContent = 'The AI Brain is online and ready.';
                    } else {
                        tag.textContent = 'Offline';
                        tag.className = 'sh-status-tag';
                        el('ai-status-text').textContent = 'Enable AI in settings to improve results.';
                    }

                    if (plan.filteredEntries > 0) {
                        el('card-ready').classList.remove('hidden');
                        el('ready-text').textContent = 'AI found ' + plan.filteredEntries + ' improvements for your library.';
                    } else {
                        el('card-ready').classList.add('hidden');
                    }
                } catch (e) { console.error(e); }
            }

            async function refreshReview() {
                Dashboard.showLoadingMsg();
                try {
                    var plan = await api('shirarium/organization-plan-view?pageSize=100');
                    state.plan = plan;
                    state.selection.clear();
                    el('selectAll').checked = false;

                    var tbody = el('table-body');
                    tbody.innerHTML = '';
                    
                    if (!plan.entries || plan.entries.length === 0) {
                        el('table-empty').classList.remove('hidden');
                        el('btn-apply-main').disabled = true;
                        return;
                    }

                    el('table-empty').classList.add('hidden');
                    el('btn-apply-main').disabled = true;

                    plan.entries.forEach(function(entry) {
                        var row = document.createElement('tr');
                        row.innerHTML = '<td><input type="checkbox" class="row-check" data-path="' + entry.sourcePath + '"></td>' +
                            '<td><div style="font-family:monospace; font-size:11px;">' + entry.sourcePath + '</div></td>' +
                            '<td><div style="color:#52B54B;">' + (entry.effectiveTargetPath || '-') + '</div></td>';
                        tbody.appendChild(row);
                    });

                    tbody.querySelectorAll('.row-check').forEach(function(chk) {
                        chk.addEventListener('change', function(e) {
                            if (e.target.checked) state.selection.add(e.target.dataset.path);
                            else state.selection.delete(e.target.dataset.path);
                            el('btn-apply-main').disabled = state.selection.size === 0;
                        });
                    });
                } finally { Dashboard.hideLoadingMsg(); }
            }

            async function loadSettings() {
                try {
                    var config = await ApiClient.getPluginConfiguration(state.pluginId);
                    var presets = await api('shirarium/ai-model-presets');
                    
                    el('chkEnableAi').checked = config.EnableAiParsing;
                    var sel = el('selectPreset');
                    sel.innerHTML = presets.presets.map(function(p) {
                        return '<option value="' + p.id + '" ' + (p.id === config.SelectedModelPreset ? 'selected' : '') + '>' + p.name + '</option>';
                    }).join('');
                    
                    var updateInfo = function() {
                        var p = presets.presets.find(function(x) { return x.id === sel.value; });
                        if (p) el('preset-info').textContent = p.rationale;
                    };
                    sel.onchange = updateInfo;
                    updateInfo();
                    state.config = config;
                } catch(e) {}
            }

            async function saveSettings(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                try {
                    state.config.EnableAiParsing = el('chkEnableAi').checked;
                    state.config.SelectedModelPreset = el('selectPreset').value;
                    await ApiClient.updatePluginConfiguration(state.pluginId, state.config);
                    Dashboard.alert('Settings saved.');
                } finally { Dashboard.hideLoadingMsg(); }
            }

            async function applySelected() {
                if (state.selection.size === 0) return;
                Dashboard.showLoadingMsg();
                try {
                    await api('shirarium/apply-reviewed-plan', 'POST', {
                        expectedPlanFingerprint: state.plan.planFingerprint,
                        sourcePaths: Array.from(state.selection)
                    });
                    Dashboard.alert('Library updated!');
                    refreshReview();
                } catch(e) { Dashboard.alert('Failed: ' + e.message); }
                finally { Dashboard.hideLoadingMsg(); }
            }

            // INIT
            document.querySelector('#ShirariumReviewPage').addEventListener('pageshow', function () {
                refreshDash();
                
                // Attempt to fix the sidebar icon via DOM manipulation (World-Class Hack)
                try {
                    var parentDoc = window.parent.document;
                    var sidebarLinks = parentDoc.querySelectorAll('.sidebarLink');
                    sidebarLinks.forEach(function(link) {
                        if (link.href.indexOf('ShirariumDashboard') !== -1) {
                            var icon = link.querySelector('.navMenuIcon');
                            if (icon) {
                                icon.textContent = 'smart_toy'; // Set to Robot icon
                                icon.style.color = '#52B54B';   // Optional: matching our brand green
                            }
                        }
                    });
                } catch (e) {
                    console.warn("Could not modify sidebar icon from iframe: " + e.message);
                }
            });

            document.querySelectorAll('.sh-tab-btn').forEach(function(btn) {
                btn.onclick = function() { switchTab(btn.dataset.tab); };
            });
            
            el('btn-start-review').onclick = function() { switchTab('review'); };
            el('btn-apply-main').onclick = applySelected;
            el('settings-form').onsubmit = saveSettings;
            el('selectAll').onclick = function(e) {
                document.querySelectorAll('.row-check').forEach(function(chk) {
                    chk.checked = e.target.checked;
                    if (e.target.checked) state.selection.add(chk.dataset.path);
                    else state.selection.delete(chk.dataset.path);
                });
                el('btn-apply-main').disabled = state.selection.size === 0;
            };

        })();
    </script>
</div>
</body>
</html>